<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>UEFA Champions League Simulator</title>
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* ========================================================
       UEFA Champions League Theming & Creative Styling
    ======================================================== */
    :root {
      --gold: #d4af37;
      --deep-blue: #012169;
      --white: #fff;
      --dark-bg: #000;
      --overlay-bg: rgba(0, 0, 0, 0.55);
      --container-bg: rgba(0, 0, 0, 0.85);
      --font-family: 'Cinzel', serif;
    }
    
    /* ========================================================
       Reset & Global Styles
    ======================================================== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: var(--font-family);
      background: var(--dark-bg);
      color: var(--white);
      overflow-x: hidden;
      scroll-behavior: smooth;
    }
    ::-webkit-scrollbar {
      width: 12px;
    }
    ::-webkit-scrollbar-thumb {
      background: #333;
      border-radius: 6px;
      border: 2px solid #000;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
    
    /* ========================================================
       Full Screen Background Video & Overlay
    ======================================================== */
    #bgVideo {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: -10;
    }
    /* Gradient overlay for readability */
    #videoOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(180deg, rgba(0,0,0,0.75) 0%, rgba(0,0,0,0.5) 50%, rgba(0,0,0,0.75) 100%);
      z-index: -5;
    }
    
    /* ========================================================
       Mute/Unmute Button
    ======================================================== */
    #muteBtn {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      border: 3px solid var(--gold);
      border-radius: 50%;
      font-size: 1.8em;
      padding: 12px;
      cursor: pointer;
      z-index: 130;
      transition: transform 0.2s ease;
    }
    #muteBtn:hover { transform: scale(1.15); }
    
    /* ========================================================
       Toast Notification
    ======================================================== */
    #toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      padding: 15px 25px;
      border: 2px solid var(--gold);
      border-radius: 8px;
      box-shadow: 0 0 20px rgba(0,0,0,0.8);
      opacity: 0;
      pointer-events: none;
      z-index: 140;
      transition: opacity 0.5s ease;
    }
    #toast.show { opacity: 1; }
    
    /* ========================================================
       Container Styles (Setup, Bracket, Champion)
    ======================================================== */
    .container {
      max-width: 1200px;
      margin: 120px auto 80px;
      padding: 40px 60px;
      background: var(--container-bg);
      border-radius: 12px;
      border: 4px solid var(--gold);
      box-shadow: 0 0 40px rgba(0, 0, 0, 0.95);
      position: relative;
      z-index: 2;
      animation: fadeIn 1.5s ease-out;
    }
    .hidden { display: none; }
    h1, h2, h3 {
      text-align: center;
      margin-bottom: 20px;
      text-shadow: 0 0 15px var(--gold);
    }
    h1 { font-size: 3em; }
    
    /* ========================================================
       Controls & Forms
    ======================================================== */
    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin-bottom: 30px;
    }
    .controls label, .pairing-options label {
      font-size: 1.2em;
    }
    select, input[type="text"] {
      background: #222;
      border: 2px solid var(--gold);
      color: var(--white);
      padding: 8px 12px;
      border-radius: 4px;
      margin-left: 10px;
      font-size: 1em;
    }
    button {
      background: var(--deep-blue);
      border: 3px solid var(--gold);
      color: var(--white);
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1.2em;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      margin-top: 20px;
    }
    button:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.8);
    }
    .team-input {
      margin: 10px auto;
      display: flex;
      gap: 10px;
      justify-content: center;
      align-items: center;
    }
    .team-input input[type="text"] { width: 240px; }
    .team-input input[type="file"] { cursor: pointer; }
    
    /* ========================================================
       Team Block Styles
    ======================================================== */
    .team-block {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
      background: rgba(0, 0, 0, 0.65);
      border: 2px solid var(--gold);
      border-radius: 10px;
      margin: 5px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .team-block:hover {
      transform: scale(1.07);
      box-shadow: 0 0 20px var(--gold);
    }
    .team-photo {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--gold);
      margin-bottom: 8px;
    }
    .team-name {
      font-size: 1.1em;
      font-weight: bold;
      padding: 4px 10px;
      background: rgba(0, 0, 0, 0.8);
      border-radius: 4px;
    }
    .text-winner { color: var(--gold); text-shadow: 0 0 10px var(--gold); }
    .text-loser { color: var(--deep-blue); opacity: 0.8; }
    .photo-winner { border-color: var(--gold); }
    .photo-loser { border-color: var(--deep-blue); }
    /* Special styling for the final winner */
    .final-winner {
      box-shadow: 0 0 30px var(--gold), 0 0 15px var(--gold);
      animation: finalGlow 2s infinite alternate;
    }
    @keyframes finalGlow {
      from { filter: brightness(1); }
      to { filter: brightness(1.4); }
    }
    
    /* ========================================================
       Bracket Styles
    ======================================================== */
    #bracket, #championBracket {
      display: flex;
      gap: 40px;
      justify-content: center;
      padding: 40px 0;
      position: relative;
    }
    .bracket-round {
      min-width: 250px;
      position: relative;
      text-align: center;
    }
    .match {
      background: #111;
      border: 3px solid var(--deep-blue);
      border-radius: 10px;
      padding: 20px;
      margin: 25px 0;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.8);
      position: relative;
      transition: transform 0.3s ease, border 0.3s ease;
    }
    .match:hover {
      transform: scale(1.05);
      border-color: var(--gold);
    }
    /* Special styling for the final match */
    .final-match {
      border-color: var(--gold);
      box-shadow: 0 0 25px var(--gold);
      animation: pulseFinal 2s infinite alternate;
    }
    @keyframes pulseFinal {
      from { transform: scale(1); }
      to { transform: scale(1.05); }
    }
    .connectors {
      position: absolute;
      right: -40px;
      width: 40px;
      height: 100%;
    }
    .connector {
      position: absolute;
      border-right: 3px solid var(--deep-blue);
      border-top: 3px solid var(--deep-blue);
      width: 40px;
      height: 50%;
      z-index: -1;
    }
    .connector.top { top: -25%; right: -40px; }
    .connector.bottom { bottom: -25%; right: -40px; }
    
    /* ========================================================
       Manual Pairing Section
    ======================================================== */
    #manualPairingContainer {
      border: 3px dashed var(--gold);
      padding: 30px;
      margin-top: 30px;
      border-radius: 10px;
      background: rgba(20,20,20,0.9);
      position: relative;
      overflow: hidden;
    }
    #manualPairingContainer::before {
      content: "";
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.04) 0%, transparent 70%);
      animation: rotateBg 25s linear infinite;
      z-index: 0;
    }
    @keyframes rotateBg { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    #manualPairingContainer > * { position: relative; z-index: 1; }
    #availableTeams, #formedMatches {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
      animation: fadeIn 1s ease-out;
    }
    .draggableTeam { cursor: grab; transition: transform 0.3s ease; }
    .draggableTeam:hover { transform: scale(1.05); }
    #pairingBucket { display: flex; align-items: center; gap: 20px; animation: slideIn 1s ease-out; }
    .dropZone {
      border: 3px dashed var(--gold);
      border-radius: 8px;
      width: 240px;
      height: 130px;
      display: flex;
      justify-content: center;
      align-items: center;
      background: rgba(0, 0, 0, 0.4);
      transition: background 0.3s ease, transform 0.3s ease;
      font-size: 1.2em;
    }
    .dropZone:hover { background: rgba(212,175,55,0.2); transform: scale(1.04); }
    .dropZone.filled { border-color: var(--gold); background: rgba(212,175,55,0.15); }
    .vs-text { font-size: 1.7em; font-weight: bold; text-shadow: 0 0 10px var(--gold); }
    
    /* ========================================================
       Champion Page – Extra Creative Celebration
    ======================================================== */
    #championDisplay {
      background: url('assets/images/champion_cup.jpg') no-repeat center center/cover;
      position: relative;
      animation: bgFade 3s ease-in-out;
      padding: 80px 60px;
      border: 4px solid var(--gold);
      text-shadow: 0 0 15px var(--gold);
      overflow: hidden;
    }
    #championDisplay::before {
      content: "";
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, transparent 40%, rgba(0,0,0,0.6) 100%);
      opacity: 0.5;
      animation: pulse 3s infinite alternate;
      z-index: -1;
    }
    @keyframes pulse {
      from { transform: scale(1); }
      to { transform: scale(1.05); }
    }
    @keyframes bgFade { from { filter: brightness(0.65); } to { filter: brightness(1); } }
    #champion {
      font-size: 3.5em;
      margin-bottom: 30px;
      animation: glowChampion 2.5s infinite alternate;
    }
    @keyframes glowChampion {
      from { text-shadow: 0 0 10px var(--gold); }
      to { text-shadow: 0 0 35px var(--gold); }
    }
    
    /* Confetti Effects */
    .confetti {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 140;
      overflow: hidden;
    }
    .confetti-piece {
      position: absolute;
      background: var(--gold);
      opacity: 0.9;
      border-radius: 3px;
      animation: fall 3s linear infinite;
    }
    @keyframes fall {
      0% { transform: translateY(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(120vh) rotate(360deg); opacity: 0; }
    }
    
    /* Fireworks Canvas (Champion) */
    #fireworks {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 150;
      display: none;
    }
    
    /* ========================================================
       Animations
    ======================================================== */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideIn { from { opacity: 0; transform: translateX(-50px); } to { opacity: 1; transform: translateX(0); } }
  </style>
</head>
<body>
  <!-- Mute/Unmute Button -->
  <button id="muteBtn">🔊</button>
  
  <!-- Fullscreen Background Video -->
  <video id="bgVideo" autoplay muted loop>
    <source src="assets/video/champions_league_video.mp4" type="video/mp4">
    Your browser does not support the video tag.
  </video>
  <!-- Gradient Overlay -->
  <div id="videoOverlay"></div>
  
  <!-- Audio Elements -->
  <audio id="bgSound" src="assets/audio/champions_league_sound.mp3" loop preload="auto"></audio>
  <audio id="winnerSound" src="assets/audio/winner.wav" preload="auto"></audio>
  <!-- Special Final Sound Effect -->
  <audio id="finalSound" src="assets/audio/final.mp3" preload="auto"></audio>
  
  <!-- Toast Notification -->
  <div id="toast"></div>
  
  <!-- Confetti Container (for champion page) -->
  <div class="confetti hidden" id="confettiContainer"></div>
  
  <!-- Fireworks Canvas (for champion page) -->
  <canvas id="fireworks"></canvas>
  
  <!-- SETUP CONTAINER -->
  <div class="container" id="setup">
    <h1>⚽ UEFA Champions League Simulator ⚽</h1>
    <div id="error"></div>
    <div class="controls">
      <label>Number of Teams:
        <select id="teamCount">
          <option value="2">2 Teams</option>
          <option value="4">4 Teams</option>
          <option value="8">8 Teams</option>
          <option value="16" selected>16 Teams</option>
        </select>
      </label>
      <div class="pairing-options">
        <label>
          <input type="radio" name="pairing" value="random" checked> Random Pairing
        </label>
        <label>
          <input type="radio" name="pairing" value="manual"> Manual Pairing
        </label>
      </div>
    </div>
    <!-- TEAM INPUTS -->
    <div id="teamInputs"></div>
    <!-- MANUAL PAIRING UI -->
    <div id="manualPairingContainer" class="hidden">
      <h3>Drag teams into the slots to create matches</h3>
      <div id="availableTeams"></div>
      <div id="pairingBucket">
        <div class="dropZone" id="dropZone1" ondragover="allowDrop(event)" ondrop="dropTeam(event, 1)">Team Slot 1</div>
        <div class="vs-text">VS</div>
        <div class="dropZone" id="dropZone2" ondragover="allowDrop(event)" ondrop="dropTeam(event, 2)">Team Slot 2</div>
      </div>
      <!-- FORMED MATCHES REVIEW -->
      <div id="formedMatches"></div>
      <button id="finishPairingBtn" class="hidden" onclick="finishManualPairing()">Finish Pairing</button>
    </div>
    <div class="action-buttons">
      <button onclick="generateTeams()">Generate Teams</button>
      <button onclick="startTournament()" id="startBtn" class="hidden">Start Tournament</button>
    </div>
  </div>
  
  <!-- TOURNAMENT BRACKET -->
  <div class="container hidden" id="tournament">
    <h2 id="roundTitle">🏆 Tournament Bracket 🏆</h2>
    <div id="bracket"></div>
  </div>
  
  <!-- CHAMPION DISPLAY -->
  <div class="container hidden" id="championDisplay">
    <h2>CHAMPION OF EUROPE</h2>
    <div id="champion"></div>
    <div id="championBracket"></div>
    <button onclick="location.reload()">New Tournament</button>
  </div>
  
  <script>
    /********************
     * Global Variables *
     ********************/
    let tournament = {
      rounds: [],
      currentRound: 0,
      pairing: 'random'
    };
    let manualPairing = {
      availableTeams: [],
      matches: [],
      dropSlots: { 1: null, 2: null }
    };

    /***********************
     * Audio & Mute Control *
     ***********************/
    const muteBtn = document.getElementById('muteBtn');
    muteBtn.addEventListener('click', () => {
      const bgSound = document.getElementById('bgSound');
      bgSound.muted = !bgSound.muted;
      muteBtn.textContent = bgSound.muted ? '🔇' : '🔊';
    });
    let bgSoundPlayed = false;
    function tryPlayBgSound() {
      if (!bgSoundPlayed) {
        const bgSound = document.getElementById('bgSound');
        bgSound.play().then(() => { bgSoundPlayed = true; })
          .catch(err => console.error("Error playing sound:", err));
      }
    }
    document.addEventListener('click', tryPlayBgSound, { once: true });

    /*********************
     * Toast Notifications *
     *********************/
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => { toast.classList.remove('show'); }, 3000);
    }
    function showError(message) { showToast(message); }

    /*********************
     * Rendering Helpers *
     *********************/
    function renderTeam(team, status) {
      const hasPhoto = !!team.photo;
      return `
        <div class="team-block ${status === 'final-winner' ? 'final-winner' : ''}">
          ${hasPhoto ? `<img src="${team.photo}" class="team-photo ${status ? 'photo-' + status : ''}" alt="${team.name}">` : ''}
          <div class="team-name ${status ? 'text-' + status : ''}">${team.name}</div>
        </div>
      `;
    }

    /********************
     * Team Generation  *
     ********************/
    function generateTeams() {
      const count = parseInt(document.getElementById('teamCount').value);
      const container = document.getElementById('teamInputs');
      container.innerHTML = '';
      for (let i = 0; i < count; i++) {
        const div = document.createElement('div');
        div.className = 'team-input';
        const nameInput = document.createElement('input');
        nameInput.type = 'text';
        nameInput.placeholder = `Team ${i+1} Name`;
        nameInput.required = true;
        nameInput.value = `Team ${i+1}`;
        div.appendChild(nameInput);
        const photoInput = document.createElement('input');
        photoInput.type = 'file';
        photoInput.accept = 'image/*';
        photoInput.style.cursor = 'pointer';
        photoInput.addEventListener('change', function(event) {
          const file = event.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function(e) { photoInput.dataset.photo = e.target.result; }
            reader.readAsDataURL(file);
          }
        });
        div.appendChild(photoInput);
        container.appendChild(div);
      }
      document.getElementById('startBtn').classList.remove('hidden');
    }

    /*********************************
     * Tournament & Bracket Functions *
     *********************************/
    function startTournament() {
      try {
        const teamDivs = Array.from(document.querySelectorAll('#teamInputs .team-input'));
        const teams = teamDivs.map(div => {
          const inputs = div.querySelectorAll('input');
          const name = inputs[0].value.trim();
          const photo = inputs[1].dataset.photo ? inputs[1].dataset.photo.trim() : "";
          if (!name) throw new Error('Please fill in all team names.');
          return { name, photo };
        });
        if (new Set(teams.map(t => t.name)).size !== teams.length)
          throw new Error('Team names must be unique.');
        if (teams.length !== parseInt(document.getElementById('teamCount').value))
          throw new Error('Incorrect number of teams entered.');
        tournament.pairing = document.querySelector('input[name="pairing"]:checked').value;
        if (tournament.pairing === 'random') {
          tournament.rounds = [{ matches: createRandomPairs(teams) }];
          document.getElementById('setup').classList.add('hidden');
          document.getElementById('tournament').classList.remove('hidden');
          renderBracket();
        } else {
          document.getElementById('teamInputs').classList.add('hidden');
          document.getElementById('startBtn').classList.add('hidden');
          startManualPairing(teams);
        }
      } catch (error) { showToast(error.message); }
    }
    function createRandomPairs(teams) {
      const shuffled = teams.slice().sort(() => Math.random() - 0.5);
      const matches = [];
      for (let i = 0; i < shuffled.length; i += 2)
        matches.push({ team1: shuffled[i], team2: shuffled[i+1], winner: null });
      return matches;
    }

    /**********************
     * Manual Pairing UI  *
     **********************/
    function startManualPairing(teams) {
      manualPairing.availableTeams = teams.slice();
      manualPairing.matches = [];
      manualPairing.dropSlots = { 1: null, 2: null };
      document.getElementById('manualPairingContainer').classList.remove('hidden');
      updateAvailableTeamsUI();
    }
    function updateAvailableTeamsUI() {
      const container = document.getElementById('availableTeams');
      container.innerHTML = '';
      manualPairing.availableTeams.forEach((team, index) => {
        const div = document.createElement('div');
        div.innerHTML = renderTeam(team);
        div.className = 'draggableTeam';
        div.setAttribute('draggable', 'true');
        div.setAttribute('data-index', index);
        div.addEventListener('dragstart', dragStart);
        container.appendChild(div);
      });
    }
    function dragStart(event) {
      event.dataTransfer.setData("text/plain", event.currentTarget.getAttribute("data-index"));
    }
    function allowDrop(event) { event.preventDefault(); }
    function dropTeam(event, zoneNumber) {
      event.preventDefault();
      const teamIndex = event.dataTransfer.getData("text/plain");
      if (teamIndex === "") return;
      if (manualPairing.dropSlots[zoneNumber] !== null) return;
      const team = manualPairing.availableTeams[teamIndex];
      manualPairing.dropSlots[zoneNumber] = { team, index: teamIndex };
      const dropZone = document.getElementById("dropZone" + zoneNumber);
      dropZone.innerHTML = renderTeam(team);
      dropZone.classList.add('filled');
      manualPairing.availableTeams.splice(teamIndex, 1);
      updateAvailableTeamsUI();
      if (manualPairing.dropSlots[1] && manualPairing.dropSlots[2])
        formMatchFromDropZones();
    }
    function formMatchFromDropZones() {
      const teamA = manualPairing.dropSlots[1].team;
      const teamB = manualPairing.dropSlots[2].team;
      manualPairing.matches.push({ team1: teamA, team2: teamB, winner: null });
      updateFormedMatchesUI();
      manualPairing.dropSlots = { 1: null, 2: null };
      document.getElementById("dropZone1").innerHTML = "Team Slot 1";
      document.getElementById("dropZone1").classList.remove('filled');
      document.getElementById("dropZone2").innerHTML = "Team Slot 2";
      document.getElementById("dropZone2").classList.remove('filled');
      if (manualPairing.availableTeams.length === 0)
        document.getElementById('finishPairingBtn').classList.remove('hidden');
    }
    function updateFormedMatchesUI() {
      const container = document.getElementById('formedMatches');
      container.innerHTML = '';
      manualPairing.matches.forEach(match => {
        const reviewCard = document.createElement('div');
        reviewCard.classList.add('match-review');
        const team1Div = document.createElement('div');
        team1Div.classList.add('review-team');
        team1Div.innerHTML = renderTeam(match.team1);
        const vsDiv = document.createElement('div');
        vsDiv.classList.add('review-vs');
        vsDiv.textContent = "VS";
        const team2Div = document.createElement('div');
        team2Div.classList.add('review-team');
        team2Div.innerHTML = renderTeam(match.team2);
        reviewCard.appendChild(team1Div);
        reviewCard.appendChild(vsDiv);
        reviewCard.appendChild(team2Div);
        container.appendChild(reviewCard);
      });
    }
    function finishManualPairing() {
      if (manualPairing.availableTeams.length > 0) {
        showToast("Please pair all teams before finishing manual pairing.");
        return;
      }
      tournament.rounds = [{ matches: manualPairing.matches.slice() }];
      document.getElementById('setup').classList.add('hidden');
      document.getElementById('manualPairingContainer').classList.add('hidden');
      document.getElementById('tournament').classList.remove('hidden');
      renderBracket();
    }

    /**************************
     * Bracket Rendering *
     **************************/
    function renderBracket() {
      const bracketDiv = document.getElementById('bracket');
      bracketDiv.innerHTML = '';
      tournament.rounds.forEach((round, roundIndex) => {
        const roundDiv = document.createElement('div');
        roundDiv.className = 'bracket-round';
        roundDiv.innerHTML = `<h3>${getRoundName(round.matches.length * 2)}</h3>`;
        round.matches.forEach((match, matchIndex) => {
          const matchDiv = document.createElement('div');
          matchDiv.className = 'match';
          // If this is the final match (only one match in the round) add special class
          if (round.matches.length === 1) {
            matchDiv.classList.add('final-match');
          }
          const teamsContainer = document.createElement('div');
          teamsContainer.className = 'teams';
          let team1Status = "";
          let team2Status = "";
          if (match.winner) {
            team1Status = (match.team1.name === match.winner.name) ? "winner" : "loser";
            team2Status = (match.team2.name === match.winner.name) ? "winner" : "loser";
            // If this is the final match, set the winning team status to "final-winner"
            if (round.matches.length === 1) {
              team1Status = (match.team1.name === match.winner.name) ? "final-winner" : team1Status;
              team2Status = (match.team2.name === match.winner.name) ? "final-winner" : team2Status;
            }
          }
          const team1Div = document.createElement('div');
          team1Div.innerHTML = renderTeam(match.team1, team1Status);
          team1Div.style.cursor = "pointer";
          if (!match.winner)
            team1Div.addEventListener('click', () => selectWinner(roundIndex, matchIndex, match.team1));
          const team2Div = document.createElement('div');
          team2Div.innerHTML = renderTeam(match.team2, team2Status);
          team2Div.style.cursor = "pointer";
          if (!match.winner)
            team2Div.addEventListener('click', () => selectWinner(roundIndex, matchIndex, match.team2));
          teamsContainer.appendChild(team1Div);
          const vsText = document.createElement('div');
          vsText.textContent = " vs ";
          vsText.style.margin = "0 5px";
          teamsContainer.appendChild(vsText);
          teamsContainer.appendChild(team2Div);
          matchDiv.appendChild(teamsContainer);
          if (roundIndex < tournament.rounds.length - 1) {
            const connectors = document.createElement('div');
            connectors.className = 'connectors';
            connectors.innerHTML = `<div class="connector top"></div><div class="connector bottom"></div>`;
            matchDiv.appendChild(connectors);
          }
          roundDiv.appendChild(matchDiv);
        });
        bracketDiv.appendChild(roundDiv);
      });
      // Center the matches between their parent matches.
      adjustPositions(bracketDiv);
    }
    function selectWinner(roundIndex, matchIndex, winner) {
      // Determine if this is the final match (only one match in current round).
      const currentRound = tournament.rounds[tournament.currentRound];
      if (currentRound.matches.length === 1) {
        // Play the special final sound.
        document.getElementById('finalSound').play().catch(err => console.error("Final sound error:", err));
      } else {
        document.getElementById('winnerSound').play().catch(err => console.error("Winner sound error:", err));
      }
      const match = tournament.rounds[roundIndex].matches[matchIndex];
      match.winner = winner;
      const rounds = document.getElementsByClassName('bracket-round');
      const currentRoundDiv = rounds[roundIndex];
      const matchDiv = currentRoundDiv.getElementsByClassName('match')[matchIndex];
      const team1Status = (match.team1.name === winner.name) ? (currentRound.matches.length === 1 ? "final-winner" : "winner") : "loser";
      const team2Status = (match.team2.name === winner.name) ? (currentRound.matches.length === 1 ? "final-winner" : "winner") : "loser";
      const teamsContainer = document.createElement('div');
      teamsContainer.className = 'teams';
      const team1Div = document.createElement('div');
      team1Div.innerHTML = renderTeam(match.team1, team1Status);
      team1Div.style.cursor = "pointer";
      const team2Div = document.createElement('div');
      team2Div.innerHTML = renderTeam(match.team2, team2Status);
      team2Div.style.cursor = "pointer";
      teamsContainer.appendChild(team1Div);
      const vsText = document.createElement('div');
      vsText.textContent = " vs ";
      vsText.style.margin = "0 5px";
      teamsContainer.appendChild(vsText);
      teamsContainer.appendChild(team2Div);
      matchDiv.innerHTML = "";
      matchDiv.appendChild(teamsContainer);
      if (roundIndex < tournament.rounds.length - 1) {
        const connectors = document.createElement('div');
        connectors.className = 'connectors';
        connectors.innerHTML = `<div class="connector top"></div><div class="connector bottom"></div>`;
        matchDiv.appendChild(connectors);
      }
      // If the current round is complete, generate the next round.
      const currentRoundMatches = tournament.rounds[tournament.currentRound].matches;
      if (currentRoundMatches.every(m => m.winner))
        createNextRound();
    }
    function createNextRound() {
      const currentMatches = tournament.rounds[tournament.currentRound].matches;
      const winners = currentMatches.map(m => m.winner);
      if (winners.length === 1) {
        showChampion(winners[0]);
        return;
      }
      const nextRoundMatches = [];
      for (let i = 0; i < winners.length; i += 2)
        nextRoundMatches.push({ team1: winners[i], team2: winners[i+1], winner: null });
      tournament.rounds.push({ matches: nextRoundMatches });
      tournament.currentRound++;
      renderBracket();
    }
    function getRoundName(teamCount) {
      const names = { 16: 'Round of 16', 8: 'Quarter Finals', 4: 'Semi Finals', 2: 'Final' };
      return names[teamCount] || `Round ${tournament.currentRound + 1}`;
    }
    
    // This function centers each match in the current round between its two parent matches.
    function adjustPositions(container) {
      const rounds = container.getElementsByClassName('bracket-round');
      if (rounds.length < 2) return;
      for (let r = 1; r < rounds.length; r++) {
        const prevRound = rounds[r - 1];
        const currRound = rounds[r];
        const prevMatches = prevRound.getElementsByClassName('match');
        const prevCenters = [];
        const prevRect = prevRound.getBoundingClientRect();
        for (let i = 0; i < prevMatches.length; i++) {
          const rect = prevMatches[i].getBoundingClientRect();
          prevCenters.push(rect.top + rect.height / 2 - prevRect.top);
        }
        const currMatches = currRound.getElementsByClassName('match');
        for (let j = 0; j < currMatches.length; j++) {
          const parentIndex1 = 2 * j;
          const parentIndex2 = 2 * j + 1;
          if (parentIndex2 >= prevCenters.length) continue;
          const desiredCenter = (prevCenters[parentIndex1] + prevCenters[parentIndex2]) / 2;
          const matchHeight = currMatches[j].offsetHeight;
          currMatches[j].style.position = "absolute";
          currMatches[j].style.top = (desiredCenter - matchHeight / 2) + "px";
          currMatches[j].style.left = "0";
        }
      }
    }
    
    /********************
     * Champion Display *
     ********************/
    function showChampion(winner) {
      document.getElementById('tournament').classList.add('hidden');
      document.getElementById('championDisplay').classList.remove('hidden');
      // Activate confetti and fireworks effects.
      document.getElementById('confettiContainer').classList.remove('hidden');
      createConfetti();
      createParticles();
      showFireworks();
      document.getElementById('champion').innerHTML = renderTeam(winner, "final-winner");
      renderChampionBracket();
    }
    function renderChampionBracket() {
      const championBracket = document.getElementById('championBracket');
      championBracket.innerHTML = '';
      tournament.rounds.forEach((round, roundIndex) => {
        const roundDiv = document.createElement('div');
        roundDiv.className = 'bracket-round';
        roundDiv.innerHTML = `<h3>${getRoundName(round.matches.length * 2)}</h3>`;
        round.matches.forEach(match => {
          const matchDiv = document.createElement('div');
          matchDiv.className = 'match';
          const teamsContainer = document.createElement('div');
          teamsContainer.className = 'teams';
          const team1Div = document.createElement('div');
          team1Div.innerHTML = renderTeam(match.team1, (match.team1.name === match.winner.name) ? "final-winner" : "loser");
          const team2Div = document.createElement('div');
          team2Div.innerHTML = renderTeam(match.team2, (match.team2.name === match.winner.name) ? "final-winner" : "loser");
          const vsText = document.createElement('div');
          vsText.textContent = " vs ";
          vsText.style.margin = "0 5px";
          teamsContainer.appendChild(team1Div);
          teamsContainer.appendChild(vsText);
          teamsContainer.appendChild(team2Div);
          matchDiv.appendChild(teamsContainer);
          if (roundIndex < tournament.rounds.length - 1) {
            const connectors = document.createElement('div');
            connectors.className = 'connectors';
            connectors.innerHTML = `<div class="connector top"></div><div class="connector bottom"></div>`;
            matchDiv.appendChild(connectors);
          }
          roundDiv.appendChild(matchDiv);
        });
        championBracket.appendChild(roundDiv);
      });
      // Also adjust the champion bracket positions.
      adjustPositions(championBracket);
    }
    
    /********************
     * Confetti Effect  *
     ********************/
    function createConfetti() {
      const confettiContainer = document.getElementById('confettiContainer');
      confettiContainer.innerHTML = '';
      for (let i = 0; i < 150; i++) {
        const piece = document.createElement('div');
        piece.classList.add('confetti-piece');
        piece.style.left = Math.random() * 100 + '%';
        piece.style.width = 8 + Math.random() * 12 + 'px';
        piece.style.height = 8 + Math.random() * 12 + 'px';
        piece.style.backgroundColor = getRandomColor();
        piece.style.opacity = Math.random();
        piece.style.top = -Math.random() * 20 + 'px';
        piece.style.transform = 'rotate(' + (Math.random() * 360) + 'deg)';
        piece.style.animationDuration = (2 + Math.random() * 3) + 's';
        confettiContainer.appendChild(piece);
      }
    }
    function getRandomColor() {
      const gold = getComputedStyle(document.documentElement).getPropertyValue('--gold').trim() || '#d4af37';
      const colors = [gold, '#e74c3c', '#9b59b6', '#3498db'];
      return colors[Math.floor(Math.random() * colors.length)];
    }
    
    /**********************************
     * Particle Effect (Champion) *
     **********************************/
    function createParticles() {
      const particleContainer = document.getElementById('confettiContainer');
      for (let i = 0; i < 50; i++) {
        const particle = document.createElement('div');
        particle.classList.add('particle');
        particle.style.width = Math.random() * 6 + 4 + 'px';
        particle.style.height = particle.style.width;
        particle.style.left = Math.random() * 100 + '%';
        particle.style.top = Math.random() * 50 + '%';
        particle.style.backgroundColor = getRandomColor();
        particle.style.animationDuration = (3 + Math.random() * 3) + 's';
        particleContainer.appendChild(particle);
      }
      setTimeout(() => { particleContainer.innerHTML = ''; }, 5000);
    }
    
    /**********************************
     * Fireworks Canvas (Champion) *
     **********************************/
    function showFireworks() {
      const canvas = document.getElementById('fireworks');
      canvas.style.display = 'block';
      const ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      let particles = [];
      function Particle(x, y, color) {
        this.x = x;
        this.y = y;
        this.radius = Math.random() * 3 + 2;
        this.color = color;
        this.speedX = (Math.random() - 0.5) * 8;
        this.speedY = (Math.random() - 0.5) * 8;
        this.alpha = 1;
      }
      Particle.prototype.update = function() {
        this.x += this.speedX;
        this.y += this.speedY;
        this.alpha -= 0.02;
      }
      Particle.prototype.draw = function() {
        ctx.save();
        ctx.globalAlpha = this.alpha;
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
        ctx.fillStyle = this.color;
        ctx.fill();
        ctx.restore();
      }
      function createFirework(x, y) {
        for (let i = 0; i < 100; i++) {
          particles.push(new Particle(x, y, getRandomColor()));
        }
      }
      function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        particles.forEach((p, index) => {
          p.update();
          p.draw();
          if (p.alpha <= 0) particles.splice(index, 1);
        });
        if (particles.length > 0) requestAnimationFrame(animate);
        else canvas.style.display = 'none';
      }
      // Trigger fireworks at random positions in the upper half of the screen.
      for (let i = 0; i < 5; i++) {
        setTimeout(() => {
          createFirework(Math.random() * canvas.width, Math.random() * canvas.height / 2);
          animate();
        }, i * 500);
      }
    }
    
    // Initially display the setup container.
    document.getElementById('setup').classList.remove('hidden');
  </script>
</body>
</html>
